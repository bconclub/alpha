name: Auto Version Bump

on:
  push:
    branches: [main]

jobs:
  bump:
    # Skip if the commit message already contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump versions
        run: |
          # Bump dashboard package.json patch version
          cd dashboard
          npm version patch --no-git-tag-version
          cd ..

          # Bump engine VERSION file
          cd engine
          CURRENT=$(cat VERSION 2>/dev/null || echo "1.0.0")
          IFS='.' read -r major minor patch <<< "$CURRENT"
          echo "$major.$minor.$((patch + 1))" > VERSION
          cd ..

      - name: Commit version bump
        run: |
          git config user.name "alpha-bot"
          git config user.email "bot@alpha"
          git add -A
          git diff --staged --quiet || git commit -m "chore: bump version [skip ci]"
          git push
